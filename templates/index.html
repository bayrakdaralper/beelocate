<!DOCTYPE html>
<html class="dark" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>BeeLocate PRO v2.5</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>

<script>
    tailwind.config = { darkMode: "class", theme: { extend: { colors: { "primary": "#FFC107", "primary-hover": "#FFB300", "bg-dark": "#212121", "surface": "#1a1a1a" }, fontFamily: { "display": ["Inter", "sans-serif"] } } } }
</script>
<style>
    #map { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    .radar-spinner { width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(from 0deg, transparent 0%, rgba(255, 193, 7, 0.5) 100%); animation: radar-spin 1.5s linear infinite; position: relative; }
    .radar-spinner::before { content: ''; position: absolute; inset: 4px; border-radius: 50%; background: #212121; }
    @keyframes radar-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #FFC107; margin-top: -6px; cursor: pointer; }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #444; border-radius: 2px; }
    .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .slide-up { animation: slideUp 0.3s ease-out forwards; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
</style>
</head>
<body class="bg-bg-dark text-white font-display overflow-hidden">

    <div class="fixed top-6 left-1/2 -translate-x-1/2 w-11/12 md:w-[600px] z-20 flex flex-col gap-3 pointer-events-none">
        <div class="flex justify-between items-center px-2 pointer-events-auto">
            <a href="/" class="flex items-center gap-2 drop-shadow-md bg-black/60 px-4 py-2 rounded-full backdrop-blur cursor-pointer border border-white/10 hover:bg-black/80 transition group">
                <span class="material-symbols-outlined text-primary text-3xl group-hover:scale-110 transition">hive</span>
                <h1 class="text-xl font-bold tracking-tight">BeeLocate <span class="text-primary">PRO</span></h1>
            </a>
            <div class="bg-black/60 backdrop-blur-md rounded-full px-1 py-1 border border-white/10 flex shadow-lg">
                <button onclick="setLang('TR')" id="btn-tr" class="px-3 py-1 rounded-full text-xs font-bold bg-primary text-black transition">TR</button>
                <button onclick="setLang('EN')" id="btn-en" class="px-3 py-1 rounded-full text-xs font-bold text-gray-400 transition">EN</button>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <div class="fixed bottom-8 left-1/2 -translate-x-1/2 z-20 flex flex-col items-center gap-3 w-[95%] max-w-sm px-0" id="analyze-container">
        <div class="bg-black/80 backdrop-blur-md p-4 rounded-2xl border border-white/10 w-full animate-fade-in-up space-y-4 shadow-2xl">
            <div class="flex items-center bg-white/10 rounded-xl px-3 h-10 border border-white/5 focus-within:border-primary transition">
                <span class="material-symbols-outlined text-gray-400 text-lg">search</span>
                <input id="search-input" class="bg-transparent border-none text-white text-sm w-full ml-2 focus:outline-none placeholder-gray-500" 
                       placeholder="Konum ara... (Örn: Sarıcakaya)" onkeypress="handleSearch(event)">
            </div>
            <div>
                <div class="flex justify-between text-[10px] text-gray-400 mb-2 font-bold uppercase tracking-wider">
                    <span id="lbl-rad">Tarama Çapı (Buffer)</span>
                    <span class="text-primary" id="rad-val">2000m</span>
                </div>
                <input type="range" id="radius-slider" min="1000" max="5000" step="500" value="2000" oninput="updateRadius(this.value)">
            </div>
        </div>
        <button onclick="runSmartAnalysis()" class="flex items-center justify-center gap-3 h-14 w-full bg-primary hover:bg-primary-hover text-[#181610] rounded-2xl shadow-xl transform transition active:scale-95 animate-fade-in-up font-bold text-lg" style="animation-delay: 0.1s;">
            <span class="material-symbols-outlined text-2xl">query_stats</span>
            <span id="btn-analyze-text">ANALİZİ BAŞLAT</span>
        </button>
    </div>

    <div id="loading-screen" class="fixed inset-0 bg-bg-dark/95 z-50 hidden flex-col items-center justify-center text-center">
        <div class="radar-spinner mb-4"></div>
        <div class="text-4xl font-black text-primary mb-2" id="loading-percent">0%</div>
        <h2 class="text-xl font-bold mb-4 text-white" id="loading-title">CBS Verileri İşleniyor...</h2>
        <div class="w-80 h-24 overflow-hidden relative">
            <div id="log-container" class="flex flex-col items-center gap-2 text-sm text-gray-400 font-mono transition-all duration-300"></div>
            <div class="absolute bottom-0 w-full h-10 bg-gradient-to-t from-bg-dark to-transparent"></div>
        </div>
        <p class="text-xs text-gray-500 mt-8 absolute bottom-10 px-4">Sunucu "Cold Start" modunda olabilir. İlk işlem 40-50sn sürebilir.</p>
    </div>

    <div id="result-modal" class="fixed inset-0 z-40 hidden flex items-end md:items-center justify-center bg-black/60 backdrop-blur-sm" onclick="closeModal(event)">
        
        <div id="main-scroll-container" class="bg-[#1e1e1e] w-full md:w-full md:max-w-6xl md:rounded-3xl rounded-t-3xl border-t md:border border-white/10 shadow-2xl h-[90vh] md:h-[750px] relative slide-up overflow-y-auto md:overflow-hidden no-scrollbar" onscroll="handleScroll(this)">
            
            <button onclick="closeModalBtn()" class="fixed md:absolute top-6 right-4 md:top-4 md:right-4 z-[60] bg-white/10 hover:bg-red-500 hover:text-white text-white rounded-full p-2 transition shadow-lg backdrop-blur-md">
                <span class="material-symbols-outlined text-2xl">close</span>
            </button>

            <div class="flex flex-col md:flex-row h-full">

                <div id="mobile-sticky-header" class="w-full md:w-1/3 bg-[#252525] flex flex-col border-b md:border-b-0 md:border-r border-white/5 relative z-40 sticky top-0 md:static transition-all duration-300 shadow-xl">
                    
                    <div class="p-5 md:p-8 flex flex-col h-full transition-all duration-300" id="header-inner">
                        <div class="text-center md:text-left flex flex-row md:flex-col items-center justify-between md:justify-start">
                            
                            <div class="flex flex-col items-center md:items-start transition-all duration-300" id="header-left-content">
                                <div class="inline-flex items-center gap-2 bg-white/5 px-3 py-1 rounded-full border border-white/5 mb-2 transition-all" id="badge-container">
                                    <span class="size-2 rounded-full bg-green-500 animate-pulse"></span>
                                    <span class="text-xs font-bold text-gray-300" id="lbl-live">CBS ANALİZİ</span>
                                </div>
                                <div class="text-gray-400 text-sm font-bold uppercase tracking-widest mb-1 hidden md:block" id="lbl-score">UYGUNLUK SKORU</div>
                            </div>

                            <div class="flex items-baseline justify-center md:justify-start gap-1 transition-all duration-300" id="score-container">
                                <span class="text-7xl md:text-8xl font-black text-primary transition-all duration-300" id="score-val">0</span>
                                <span class="text-xl md:text-2xl text-gray-500 font-bold">/100</span>
                            </div>
                            
                            <div class="md:mt-2 text-green-400 font-bold text-lg md:text-xl flex items-center md:w-full justify-center md:justify-start gap-2 transition-all duration-300" id="status-container">
                                <span class="material-symbols-outlined">trending_up</span>
                                <span id="score-comment" class="hidden md:inline">--</span>
                            </div>
                        </div>
                        
                        <div id="desc-container" class="mt-4 p-3 bg-black/20 rounded-xl border-l-2 border-primary text-center md:text-left transition-all duration-300 overflow-hidden" style="max-height: 200px; opacity: 1;">
                            <p class="text-sm text-gray-300 leading-relaxed" id="dynamic-text">...</p>
                        </div>
                        
                        <div class="hidden md:block mt-auto pt-6 opacity-30 text-[10px] uppercase tracking-widest text-center">BeeLocate - GIS Decision Support System</div>
                    </div>
                </div>

                <div id="scroll-content-area" class="w-full md:w-2/3 p-4 md:p-8 relative bg-[#1e1e1e] overflow-visible md:overflow-y-auto no-scrollbar">
                    
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-3 py-2">
                        <h3 class="text-lg md:text-2xl font-bold text-white text-center md:text-left hidden md:block" id="lbl-details">Arazi Parametreleri</h3>
                        <button onclick="downloadReport()" class="bg-primary hover:bg-primary-hover text-black px-6 py-3 rounded-xl text-sm font-bold transition flex items-center justify-center gap-2 shadow-lg w-full md:w-auto transform active:scale-95">
                            <span class="material-symbols-outlined">download</span> <span id="btn-dl">Fizibilite Raporu (PDF)</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4 pb-12" id="metrics-grid"></div>
                    
                    <div class="h-24 md:hidden"></div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const T = {
            'TR': { 
                ph:'Konum ara... (Örn: Sarıcakaya)', btn:'ANALİZİ BAŞLAT', load:'CBS Verileri İşleniyor...', 
                logs:['OSM Vektör Verisi Çekiliyor...','LULC (Arazi Kullanım) Analizi...','Hidrografik Mesafe Ölçümü...','Mikroklima Verisi İşleniyor...'], 
                live:'CBS ANALİZİ', score:'UYGUNLUK SKORU', dl:'FİZİBİLİTE RAPORU (PDF)', rad:'Tarama Çapı (Buffer)', det:'Arazi Parametreleri', 
                high:'Yüksek Potansiyel', risk:'Kısıtlı/Riskli Alan', not_found:'Veri Yok', access_err:'Erişim Kısıtlı',
                lbl: {flora:'VEJETASYON', water:'HİDROGRAFİ', wind:'RÜZGAR HIZI', aspect:'BAKI ANALİZİ', hum:'NEM', slope:'EĞİM', road:'ULAŞIM AĞI', build:'ANTROPOJENİK BASKI', elev:'RAKIM (DEM)', temp:'SICAKLIK'}
            },
            'EN': { 
                ph:'Search location...', btn:'START ANALYSIS', load:'Processing GIS Data...', 
                logs:['Fetching OSM Vectors...','LULC Analysis...','Hydrographic Distance Calc...','Processing Microclimate...'], 
                live:'GIS ANALYSIS', score:'SUITABILITY SCORE', dl:'FEASIBILITY REPORT (PDF)', rad:'Scan Radius (Buffer)', det:'Terrain Parameters', 
                high:'High Potential', risk:'Restricted/Risky Area', not_found:'No Data', access_err:'Restricted Access',
                lbl: {flora:'VEGETATION', water:'HYDROGRAPHY', wind:'WIND SPEED', aspect:'ASPECT', hum:'HUMIDITY', slope:'SLOPE', road:'TRANSPORT NETWORK', build:'ANTHROPOGENIC PRESSURE', elev:'ELEVATION (DEM)', temp:'TEMP'}
            }
        };
        
        const INFO = {
            'VEJETASYON': 'Flora yoğunluğu ve nektar potansiyeli (Land Use/Land Cover analizi).',
            'HİDROGRAFİ': 'Su kaynaklarına kuş uçuşu mesafe (Euclidean distance).',
            'RÜZGAR HIZI': 'Bölgesel rüzgar koridoru ve aerodinamik uygunluk.',
            'BAKI ANALİZİ': 'Arazinin güneşe yönelimi (Aspect). Termal verimlilik için kritik.',
            'NEM': 'Bağıl nem oranı.',
            'EĞİM': 'Topografik eğim yüzdesi. Saha operasyon güvenliği için önemli.',
            'ULAŞIM AĞI': 'Lojistik erişilebilirlik analizi.',
            'ANTROPOJENİK BASKI': 'Yerleşim ve yapılaşma yoğunluğu stresi.',
            'RAKIM (DEM)': 'Dijital Yükseklik Modeli verisi.',
            'SICAKLIK': 'Ortalama sıcaklık rejimi.'
        };
        
        let lang = 'TR';
        let sLat, sLng, radius = 2000;
        let currentData = null; 
        let map, marker, circle, heatLayerGroup;
        let progressInterval;

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([39.8105, 30.5050], 12); 
            var sat = L.tileLayer('https://mt0.google.com/vt/lyrs=y&hl=en&x={x}&y={y}&z={z}', {attribution:'Google Satellite | BeeLocate'});
            sat.addTo(map);
            L.control.zoom({position:'bottomright'}).addTo(map);
            heatLayerGroup = L.layerGroup().addTo(map);
            map.on('click', function(e) { updateLocation(e.latlng.lat, e.latlng.lng); });
        }

        // --- GÜNCELLENMİŞ STICKY JS (SAFE AREA FIX v2 - Bottom Align) ---
        function handleScroll(el) {
            if (window.innerWidth >= 768) return; 

            const scrollTop = el.scrollTop;
            const inner = document.getElementById('header-inner');
            const scoreVal = document.getElementById('score-val');
            const descContainer = document.getElementById('desc-container');
            const badgeContainer = document.getElementById('badge-container');
            
            if (scrollTop > 50) {
                // KÜÇÜLTME MODU
                // h-28 (112px) yüksekliğe sabitle, items-end ile yazıyı DİBE it, pb-4 ile alttan boşluk ver.
                inner.classList.remove('p-5');
                inner.classList.add('h-28', 'items-end', 'pb-4', 'px-4', 'flex-row', 'justify-between', 'border-b', 'border-white/10', 'bg-[#1e1e1e]', 'shadow-xl');
                
                scoreVal.classList.remove('text-7xl');
                scoreVal.classList.add('text-4xl');
                
                descContainer.style.display = 'none'; 
                badgeContainer.style.display = 'none';

            } else {
                // NORMAL MOD
                inner.classList.add('p-5');
                inner.classList.remove('h-28', 'items-end', 'pb-4', 'px-4', 'flex-row', 'justify-between', 'border-b', 'border-white/10', 'bg-[#1e1e1e]', 'shadow-xl');
                
                scoreVal.classList.add('text-7xl');
                scoreVal.classList.remove('text-4xl');
                
                descContainer.style.display = 'block';
                badgeContainer.style.display = 'inline-flex';
            }
        }

        function updateLocation(lat, lng) {
            if(marker) map.removeLayer(marker); 
            heatLayerGroup.clearLayers();
            sLat = lat; sLng = lng;
            marker = L.marker([lat, lng]).addTo(map);
            updateCircle();
        }

        async function handleSearch(e) {
            if (e.key === 'Enter') {
                const query = document.getElementById('search-input').value;
                if (!query) return;
                document.getElementById('search-input').blur();
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
                    const data = await res.json();
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        map.setView([lat, lon], 13);
                        updateLocation(lat, lon);
                    } else { alert("Konum bulunamadı."); }
                } catch (err) { console.error(err); }
            }
        }

        function updateRadius(val) {
            radius = val;
            document.getElementById('rad-val').innerText = val + "m";
            updateCircle();
        }

        function updateCircle() {
            if(circle) map.removeLayer(circle);
            if(sLat) circle = L.circle([sLat, sLng], {color:'#FFC107', fillColor:'#FFC107', fillOpacity:0.1, radius: radius}).addTo(map);
        }

        function startProgress() {
            let percent = 0;
            const el = document.getElementById('loading-percent');
            const logBox = document.getElementById('log-container');
            logBox.innerHTML = '';
            const logs = T[lang].logs;
            let logIndex = 0;
            
            progressInterval = setInterval(() => {
                let increment = 0;
                if(percent < 30) increment = Math.random() * 5;
                else if(percent < 70) increment = Math.random() * 2;
                else if(percent < 95) increment = Math.random() * 0.5;
                
                percent += increment;
                if(percent > 99) percent = 99;
                
                el.innerText = Math.floor(percent) + "%";
                
                if (percent > (logIndex + 1) * 20 && logIndex < logs.length) {
                    let p = document.createElement('p'); 
                    p.innerText = logs[logIndex]; 
                    p.style.color = '#4ade80';
                    logBox.prepend(p);
                    logIndex++;
                }
            }, 100);
        }

        function stopProgress() {
            clearInterval(progressInterval);
            document.getElementById('loading-percent').innerText = "100%";
        }

        async function runSmartAnalysis() {
            if(!sLat || !sLng) { alert("Lütfen haritadan bir nokta seçin."); return; }
            document.getElementById('loading-screen').style.display = 'flex';
            startProgress();
            try {
                const res = await fetch('/analyze', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ lat: sLat, lng: sLng, radius: radius, lang: lang })
                });
                const data = await res.json();
                stopProgress();
                await new Promise(r => setTimeout(r, 500));
                document.getElementById('loading-screen').style.display = 'none';
                if (data.error) { alert("Sistem Hatası: " + data.error); return; }
                currentData = data;
                document.getElementById('result-modal').style.display = 'flex';
                updateUI();
                drawHeatmap(data.heatmap);
            } catch (e) { stopProgress(); alert("Sunucu Bağlantı Hatası: " + e); document.getElementById('loading-screen').style.display = 'none'; }
        }

        function drawHeatmap(points) {
            points.forEach(p => {
                let col = p.val > 70 ? '#2ecc71' : (p.val > 40 ? '#f1c40f' : '#e74c3c');
                L.circle([p.lat, p.lng], { color: col, fillColor: col, fillOpacity: 0.4, radius: radius/5, stroke: false }).addTo(heatLayerGroup);
            });
        }

        function updateUI() {
            if (!currentData || !currentData.details) return;
            const d = currentData.details; const s = currentData.breakdown;
            const L = T[lang];

            document.getElementById('score-val').innerText = currentData.score;
            document.getElementById('score-comment').innerText = currentData.score > 70 ? L.high : L.risk;
            document.getElementById('dynamic-text').innerHTML = currentData.ai_text;

            const waterText = d.d_water >= 9000 ? L.not_found : d.d_water + "m";
            const roadText = d.d_road >= 5000 ? L.access_err : d.d_road + "m";

            const metrics = [
                { l: L.lbl.flora, v: d.flora_type, s: s.flora, i: "forest" },
                { l: L.lbl.water, v: waterText, s: s.water, i: "water_drop" },
                { l: L.lbl.wind, v: `${d.avg_wind} km/h`, s: s.wind, i: "air" },
                { l: L.lbl.aspect, v: d.dir_tr, s: s.aspect, i: "wb_sunny" },
                { l: L.lbl.hum, v: "%" + d.avg_hum, s: 50, i: "humidity_percentage" },
                { l: L.lbl.slope, v: "%" + parseInt(d.s_val), s: s.slope, i: "landscape" },
                { l: L.lbl.road, v: roadText, s: s.road, i: "add_road" },
                { l: L.lbl.build, v: d.b_count, s: s.build, i: "location_city" },
                { l: L.lbl.elev, v: d.elevation + "m", s: 100, i: "landscape" },
                { l: L.lbl.temp, v: d.avg_temp + " °C", s: s.temp, i: "thermostat" }
            ];

            const grid = document.getElementById('metrics-grid'); 
            grid.innerHTML = '';
            metrics.forEach(m => {
                const barColor = m.s > 70 ? "bg-green-500" : (m.s > 40 ? "bg-yellow-500" : "bg-red-500");
                const infoText = INFO[m.l] || "Analiz kriteri.";
                
                grid.innerHTML += `
                <div class="bg-white/5 p-4 rounded-xl border border-white/5 flex flex-col justify-between relative group hover:border-primary/50 transition">
                    <span class="material-symbols-outlined absolute top-2 right-2 text-gray-500 text-sm cursor-help hover:text-white transition" data-tippy-content="${infoText}">info</span>
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-1">${m.l}</div>
                            <div class="text-white font-bold text-lg leading-tight truncate w-32 md:w-40" title="${m.v}">${m.v}</div>
                        </div>
                        <span class="material-symbols-outlined text-gray-600 text-2xl">${m.i}</span>
                    </div>
                    <div class="w-full h-1.5 bg-gray-700 mt-2 rounded-full overflow-hidden">
                        <div class="h-full ${barColor}" style="width: ${m.s}%"></div>
                    </div>
                </div>`;
            });
            tippy('[data-tippy-content]');
        }

        function setLang(l) { lang = l; if(currentData) runSmartAnalysis(); }
        function closeModal(e) { if(e.target.id === 'result-modal') document.getElementById('result-modal').style.display='none'; }
        function closeModalBtn() { document.getElementById('result-modal').style.display='none'; }
        function downloadReport() { window.open(`/download_report?lat=${sLat}&lng=${sLng}&radius=${radius}&lang=${lang}`, '_blank'); }

        initMap();
    </script>
</body>
</html>
